import React, { useState } from "react";
import { cryptonateAbi } from "../abi/abi";
import Web3 from "web3";

import "./Payment.css";
import SocialPersonOutline from "material-ui/svg-icons/social/person-outline";
import ContentRemoveCircleOutline from "material-ui/svg-icons/content/remove-circle-outline";

const BigNumber = require('bignumber.js');

const HDWalletProvider = require('@truffle/hdwallet-provider');
const mnemonic = 'dwarf tiger slot hockey divorce decrease cat satisfy rhythm similar plunge cinnamon';
const wallet = new HDWalletProvider(mnemonic, "https://rinkeby.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161");
const ethNetwork = 'https://rinkeby.infura.io/v3/a25a59096a4046258848674cfe1c8eff';
const web3 = new Web3(wallet);
const account = "0x16299BEE572E4767794afdffF09ABaF0c33F7345";
const contractAddress = "0x32F2f283106c61F5A2B97C34864f7fA97307D719";
const contractBytecode = "0x608060405260008060006101000a81548160ff021916908315150217905550600060015560006002556040516200175b3803806200175b83398181016040526200004d919081019062000549565b6040516020016200005e9062000713565b6040516020818303038152906040528051906020012085604051602001620000879190620006fa565b604051602081830303815290604052805190602001201415620000b85762015180840242016001819055506200015a565b604051602001620000c9906200072a565b6040516020818303038152906040528051906020012085604051602001620000f29190620006fa565b6040516020818303038152906040528051906020012014156200011c578360028190555062000159565b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001509062000741565b60405180910390fd5b5b8260038190555081600490805190602001906200017992919062000253565b5080600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555033600760006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060008090505b82518110156200024757600560009080600181540180825580915050906001820390600052602060002001600090919290919091505550808060010191505062000202565b505050505050620008e3565b828054828255906000526020600020908101928215620002a7579160200282015b82811115620002a657825182908051906020019062000295929190620002ba565b509160200191906001019062000274565b5b509050620002b6919062000341565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620002fd57805160ff19168380011785556200032e565b828001600101855582156200032e579182015b828111156200032d57825182559160200191906001019062000310565b5b5090506200033d919062000372565b5090565b6200036f91905b808211156200036b57600081816200036191906200039a565b5060010162000348565b5090565b90565b6200039791905b808211156200039357600081600090555060010162000379565b5090565b90565b50805460018160011615610100020316600290046000825580601f10620003c25750620003e3565b601f016020900490600052602060002090810190620003e2919062000372565b5b50565b600081519050620003f781620008af565b92915050565b600082601f8301126200040f57600080fd5b815162000426620004208262000791565b62000763565b9150818183526020840193506020810190508360005b838110156200047057815186016200045588826200047a565b8452602084019350602083019250506001810190506200043c565b5050505092915050565b600082601f8301126200048c57600080fd5b8151620004a36200049d82620007ba565b62000763565b91508082526020830160208301858383011115620004c057600080fd5b620004cd83828462000879565b50505092915050565b600082601f830112620004e857600080fd5b8151620004ff620004f982620007e7565b62000763565b915080825260208301602083018583830111156200051c57600080fd5b6200052983828462000879565b50505092915050565b6000815190506200054381620008c9565b92915050565b600080600080600060a086880312156200056257600080fd5b600086015167ffffffffffffffff8111156200057d57600080fd5b6200058b88828901620004d6565b95505060206200059e8882890162000532565b9450506040620005b18882890162000532565b935050606086015167ffffffffffffffff811115620005cf57600080fd5b620005dd88828901620003fd565b9250506080620005f088828901620003e6565b9150509295509295909350565b60006200060a8262000814565b62000616818562000830565b93506200062881856020860162000879565b80840191505092915050565b6000620006436018836200081f565b91507f4572726f722c20696e636f727265637420656e645479706500000000000000006000830152602082019050919050565b60006200068560048362000830565b91507f54696d65000000000000000000000000000000000000000000000000000000006000830152600482019050919050565b6000620006c760058362000830565b91507f4d6f6e65790000000000000000000000000000000000000000000000000000006000830152600582019050919050565b6000620007088284620005fd565b915081905092915050565b6000620007208262000676565b9150819050919050565b60006200073782620006b8565b9150819050919050565b600060208201905081810360008301526200075c8162000634565b9050919050565b6000604051905081810181811067ffffffffffffffff821117156200078757600080fd5b8060405250919050565b600067ffffffffffffffff821115620007a957600080fd5b602082029050602081019050919050565b600067ffffffffffffffff821115620007d257600080fd5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff821115620007ff57600080fd5b601f19601f8301169050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b600062000848826200084f565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b83811015620008995780820151818401526020810190506200087c565b83811115620008a9576000848401525b50505050565b620008ba816200083b565b8114620008c657600080fd5b50565b620008d4816200086f565b8114620008e057600080fd5b50565b610e6880620008f36000396000f3fe60806040526004361061004a5760003560e01c806324850e101461004f5780639ac9f2a014610078578063d321fe29146100a3578063d6f5ef0e146100ce578063f14faf6f146100f9575b600080fd5b34801561005b57600080fd5b50610076600480360361007191908101906106f2565b610115565b005b34801561008457600080fd5b5061008d610413565b60405161009a9190610d6e565b60405180910390f35b3480156100af57600080fd5b506100b8610477565b6040516100c59190610d6e565b60405180910390f35b3480156100da57600080fd5b506100e361047f565b6040516100f09190610bc7565b60405180910390f35b610113600480360361010e919081019061071b565b6104a9565b005b600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806101be5750600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b6101fd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101f490610c8e565b60405180910390fd5b801561023d577fc24863361f36ef84e929ff8c973b1b1a70d6bd103bc504404ec17625621022d460405161023090610c4e565b60405180910390a16102ec565b60006002541461029a576000809054906101000a900460ff16610295576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028c90610cae565b60405180910390fd5b6102eb565b6000600154146102ea576001544210156102e9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102e090610cee565b60405180910390fd5b5b5b5b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f19350505050158015610354573d6000803e3d6000fd5b506000809050600080905060008090505b6005805490508110156103bc57816005828154811061038057fe5b906000526020600020015411156103af57809250600581815481106103a157fe5b906000526020600020015491505b8080600101915050610365565b507f51c8f2451c56bfb872c3f0e3bfb87c9f2cbeb86f687f3eea24d8889c6c8d11c0600483815481106103eb57fe5b90600052602060002001824760405161040693929190610be2565b60405180910390a1505050565b600080600154141561045a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161045190610d4e565b60405180910390fd5b426001541061046f5742600154039050610474565b600090505b90565b600047905090565b6000600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600060025414610507576000809054906101000a900460ff1615610502576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104f990610d2e565b60405180910390fd5b610557565b600060015414610556576001544210610555576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161054c90610c6e565b60405180910390fd5b5b5b60035434101561059c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059390610cce565b60405180910390fd5b60058054905081106105e3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105da90610d0e565b60405180910390fd5b600060035434816105f057fe5b049050806005838154811061060157fe5b90600052602060002001600082825401925050819055507f062f1d5a794ea13debe744539d31ce78a7f0ad6eddda310c7110bcf0912fd14c6004838154811061064657fe5b90600052602060002001824260405161066193929190610be2565b60405180910390a160025447106106c45760016000806101000a81548160ff0219169083151502179055507f1b8b01f5ad9b9f4dc723cb3e85093748f9d9bac7e26d7af5786a5990e0da9fcb476040516106bb9190610c20565b60405180910390a15b5050565b6000813590506106d781610df7565b92915050565b6000813590506106ec81610e0e565b92915050565b60006020828403121561070457600080fd5b6000610712848285016106c8565b91505092915050565b60006020828403121561072d57600080fd5b600061073b848285016106dd565b91505092915050565b61074d81610daf565b82525050565b6000815460018116600081146107705760018114610796576107da565b607f60028304166107818187610d9e565b955060ff1983168652602086019350506107da565b600282046107a48187610d9e565b95506107af85610d89565b60005b828110156107d1578154818901526001820191506020810190506107b2565b80880195505050505b505092915050565b60006107ef601a83610d9e565b91507f54686520646f6e6174696f6e20676f616c20776173206d6574210000000000006000830152602082019050919050565b600061082f603e83610d9e565b91507f416e20656d657267656e6379206f766572726964652077617320696e6974696160008301527f74656420746f2072656c65617365207468652066756e6473206561726c7900006020830152604082019050919050565b6000610895602783610d9e565b91507f4572726f722c207468652063616d706169676e20646561646c696e652068617360008301527f20706173736564000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006108fb604283610d9e565b91507f4572726f722c206d73672e73656e64657220646f6573206e6f7420686176652060008301527f617574686f72697a6174696f6e20746f2072756e20746869732066756e63746960208301527f6f6e0000000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000610987602983610d9e565b91507f4572726f722c2074686520646f6e6174696f6e20676f616c20686173206e6f7460008301527f206265656e206d657400000000000000000000000000000000000000000000006020830152604082019050919050565b60006109ed603683610d9e565b91507f4572726f722c206d73672e76616c7565206973206c657373207468616e20746860008301527f65206d696e696d756d20636f6e747269627574696f6e000000000000000000006020830152604082019050919050565b6000610a53602b83610d9e565b91507f4572726f722c207468652063616d706169676e20646561646c696e652068617360008301527f206e6f74207061737365640000000000000000000000000000000000000000006020830152604082019050919050565b6000610ab9602e83610d9e565b91507f4572726f722c2070726f6a6563742073656c656374696f6e206973206e6f742060008301527f612076616c6964206f7074696f6e0000000000000000000000000000000000006020830152604082019050919050565b6000610b1f602d83610d9e565b91507f4572726f722c2074686520646f6e6174696f6e20676f616c2068617320616c7260008301527f65616479206265656e206d6574000000000000000000000000000000000000006020830152604082019050919050565b6000610b85601783610d9e565b91507f4572726f722c206e6f2074696d6520676f616c207365740000000000000000006000830152602082019050919050565b610bc181610ded565b82525050565b6000602082019050610bdc6000830184610744565b92915050565b60006060820190508181036000830152610bfc8186610753565b9050610c0b6020830185610bb8565b610c186040830184610bb8565b949350505050565b60006040820190508181036000830152610c39816107e2565b9050610c486020830184610bb8565b92915050565b60006020820190508181036000830152610c6781610822565b9050919050565b60006020820190508181036000830152610c8781610888565b9050919050565b60006020820190508181036000830152610ca7816108ee565b9050919050565b60006020820190508181036000830152610cc78161097a565b9050919050565b60006020820190508181036000830152610ce7816109e0565b9050919050565b60006020820190508181036000830152610d0781610a46565b9050919050565b60006020820190508181036000830152610d2781610aac565b9050919050565b60006020820190508181036000830152610d4781610b12565b9050919050565b60006020820190508181036000830152610d6781610b78565b9050919050565b6000602082019050610d836000830184610bb8565b92915050565b60008190508160005260206000209050919050565b600082825260208201905092915050565b6000610dba82610dcd565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b610e0081610dc1565b8114610e0b57600080fd5b50565b610e1781610ded565b8114610e2257600080fd5b5056fea365627a7a7231582094ccd0e41a5020b739a2f268c23de14e91a8c46291119df9586916e495fe933a6c6578706572696d656e74616cf564736f6c63430005100040";
const cryptoContract = new web3.eth.Contract(cryptonateAbi, contractAddress);
cryptoContract.deploy({
    arguments: ["Time", 50, 1, ["Well", "Farm", "House"], '0x66C114C24e9a2012c5c2e55cd2784F46fDA838dE'],
    data: contractBytecode
});
const truffleAssert = require('truffle-assertions');
console.log(cryptoContract.methods.minContribution);

export default function Payment() {
    const [override, setOverride] = useState(false);
    const [vote, setVote] = useState('');
    const [minContribution, setminContribution] = useState(0);
    const [value, setValue] = useState(minContribution);
    const [goalMet, setGoalMet] = useState(false);

      const donate = async (t) => {
        t.preventDefault();
        const accounts = await window.ethereum.enable();
        const account = accounts[0];
        const newVote = parseInt(vote);
        const newValue = parseInt(value);
                
        const post = await cryptoContract.methods.donate(newVote).send({
          from: account,
          to: '0x66C114C24e9a2012c5c2e55cd2784F46fDA838dE',
          value: newValue
        }); 

    

        if ("DonationGoalMet" === ((await cryptoContract.getPastEvents("allEvents", {fromBlock: 0, toBlock: "latest"})).slice(-1)[0]["event"])) {
          setGoalMet(true);
          console.log("You have done it my man!");
        }
      };

      const releaseFunds = async (t) => {
        t.preventDefault();
        const newOverride = false;

        const post = await cryptoContract.methods.releaseFunds(newOverride).send({
          from: account
        });

        truffleAssert.eventEmitted(cryptoContract, 'FundsSent', (event) => {
            return event.project;
        });
      };

    return (
        <div className="donation__main">
        <div className="donation__card">
          <form className="donation__form" onSubmit={donate}>
            <label>
              Enter Vote:
              <input
                className="input"
                type="number"
                name="name"
                onChange={event => setVote(event.target.value)}
              />
            </label>
            <br/>
            <label>
              Enter Donation Amount:
              <input
                className="input"
                type="number"
                name="name"
                onChange={event => setValue(event.target.value)}
              />
            </label>
  
            <button className="button" type="submit" value="Confirm">
              Confirm
            </button>
          </form>
          <br />
          <button className="button" onClick={releaseFunds} type="button">
            Release Funds
          </button>
        </div>
      </div>
    );
}
